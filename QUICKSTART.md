# SafeSheet Quick Start Guide

## Installation

1. Install dependencies:
```bash
pip install -r requirements.txt
```

2. Set up your LLM API key (choose one):
   - Create a `.env` file in the project root
   - Add either:
     ```
     ANTHROPIC_API_KEY=your_key_here
     ```
     OR
     ```
     OPENAI_API_KEY=your_key_here
     ```

## Usage Examples

### Command Line Interface

#### Analyze a SQL file:
```bash
python -m safesheet analyze examples/example_queries.sql
```

#### Analyze SQL from command line:
```bash
python -m safesheet analyze --sql "UPDATE users SET status = 'inactive'"
```

#### Analyze SQL from stdin:
```bash
echo "DROP TABLE users" | python -m safesheet analyze
```

#### Dry-run only (no rollback generation):
```bash
python -m safesheet analyze --sql "UPDATE users SET status = 'active'" --no-rollback
```

#### Save report to file:
```bash
python -m safesheet analyze examples/example_queries.sql -o report.txt
```

### Python API

```python
from safesheet import analyze_sql, SafetyReport

# Simple analysis
sql = "UPDATE users SET status = 'inactive'"
report = analyze_sql(sql, include_rollback=True, include_dry_run=True)

print(f"Risk Level: {report['risk_level']}")
print(f"Warnings: {report['warnings']}")
print(f"Rollback: {report['rollback_script']}")

# Using SafetyReport class for formatted output
report_gen = SafetyReport(sql, include_rollback=True)
report = report_gen.generate()
formatted = report_gen.format_report(report)
print(formatted)
```

## Understanding the Safety Report

### Risk Levels

- **Low**: SELECT (read-only) or INSERT statements
- **Medium**: UPDATE or DELETE statements
- **High**: ALTER, DROP, or TRUNCATE statements

### Report Components

1. **Risk Level**: Overall risk assessment
2. **Impact Analysis**: 
   - Tables affected
   - Columns affected
   - Whether a WHERE clause exists
3. **Warnings**: Specific safety concerns
4. **Explanation**: Why this risk level was assigned
5. **Rollback Script**: SQL to undo the changes (if LLM is configured)
6. **Dry Run Results**: Simulation of the SQL execution (if enabled)

## Example Output

```
================================================================================
SAFETY REPORT
================================================================================

SQL Statement:
--------------------------------------------------------------------------------
UPDATE users SET status = 'inactive'

Risk Level: ⚠️ Medium

Statement Type: UPDATE

Impact Analysis:
--------------------------------------------------------------------------------
  Tables Affected: 1
  Tables: users
  Columns Affected: 1
    - users: status
  Has WHERE Clause: False

Warnings:
--------------------------------------------------------------------------------
  ⚠️  CRITICAL: This UPDATE statement lacks a WHERE clause and will affect ALL rows in users.

Explanation:
--------------------------------------------------------------------------------
  Risk Level: Medium This UPDATE statement will affect ALL rows in users because it lacks a WHERE clause.

Rollback Script:
--------------------------------------------------------------------------------
-- Rollback script generated by LLM
UPDATE users SET status = 'active' WHERE status = 'inactive';
```

## Best Practices

1. **Always review the safety report** before executing SQL
2. **Use dry-run** to simulate changes before applying them
3. **Generate rollback scripts** for all non-read-only operations
4. **Test rollback scripts** in a development environment first
5. **Backup critical data** before running high-risk statements

## Troubleshooting

### "No LLM API key found"
- Make sure you've created a `.env` file with either `ANTHROPIC_API_KEY` or `OPENAI_API_KEY`
- Rollback generation will be skipped, but other features will work

### "Failed to parse SQL"
- Check that your SQL syntax is correct
- SafeSheet uses `sqlglot` which supports most SQL dialects

### Dry-run simulation errors
- Dry-run uses DuckDB which may not support all SQL features
- Some DDL statements (CREATE, ALTER, DROP) cannot be fully simulated

